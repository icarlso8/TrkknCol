<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniAdsAI_Tigo</title>
  <link rel="icon" href="../../assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Mulish', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 540px;
      padding: 2px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .textarea-jerarquia {
      display: block;
      width: 100%;
      margin-right: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
    .canvas-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    fieldset.form-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 6px; /* Interlineado entre secciones */
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    fieldset.form-group .form-section,
    fieldset.form-group > div.form-section {
      margin-bottom: 12px;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Mulish', sans-serif;
      max-width: 260px;
      color: #000;
      background-color: #fff;
    } 
    .label-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-width: 100%;
    }
    .label-wrapper label {
      min-width: 160px;
      text-align: right;
    }
    .label-wrapper select {
      flex: 1;
    }
    /* Sangr√≠a y alineaci√≥n para checkboxes en m√∫ltiples l√≠neas */
    .form-section label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-size: 15px;
    }
    .form-section label input[type="checkbox"] {
      margin-top: 2px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    .form-section label span {
      display: inline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .form-section.checkbox-opciones {
      margin-left: 24px;
    }
    .galeria-thumbs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
      max-width: 100%;
      overflow-x: auto;
    }
    .thumbnail-preview {
      width: 60px;
      height: auto;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
    }
    .thumbnail-preview:hover {
      transform: scale(1.05);
      border-color: #555;
    }
    /* Galer√≠a global de resultados */
    #resultados {
      margin-top: 32px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    #resultados h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
    }
    #galeriaResultados {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      align-items: start;
    }
    .thumb-wrapper {
      background: #fff;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      text-align: center;
    }
    .thumb-wrapper .thumbnail-preview {
      width: 100%;
      height: auto;
      cursor: pointer;
      border-radius: 4px;
    }
    .thumb-wrapper .thumb-title {
      font-size: 12px;
      margin-top: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .thumb-wrapper a.download-link {
      display:block;
      margin-top:6px;
      font-size:12px;
      color:#0b66c3;
      text-decoration:none;
    }
    .fila1, .fila2 {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;               /* üîπ espacio entre elementos dentro de la fila, controla el espacio horizontal y vertical entre los botones dentro de la misma fila. */
      margin-bottom: 2px;
    }
    /* Tama√±o uniforme para botones */
    .fila1 button,
    .fila2 button {
      width: 30px;           /* ancho */
      height: 30px;          /* alto */
      font-size: 20px;       /* tama√±o de emoji o texto */
      padding: 0;
      border-radius: 6px;
      box-sizing: border-box; /* asegura tama√±o exacto incluyendo bordes */
    }
    /* Tama√±o uniforme para selects y color pickers */
    .fila1 select,
    .fila2 select,
    .fila1 input[type="color"],
    .fila2 input[type="color"] {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 6px;
      box-sizing: border-box;
    }
    /* Sliders m√°s compactos */
    .fila1 input[type="range"],
    .fila2 input[type="range"] {
      height: 20px;
      box-sizing: border-box;
    }
    /* ===== ESTILOS GENERALES DEL CONTENEDOR PRINCIPAL ===== */
    #main-container {
      display: flex;
      gap: 0;
      align-items: flex-start;
      position: relative;
      width: 100%;
    }
    /* ===== ESTILOS DE COLUMNAS ===== */
    #col-formularios {
      width: 480px;
      min-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex-shrink: 0;
    }
    #col-canvas {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
      overflow-y: auto;
      max-height: 90vh;
    }
    #col-gemini {
      width: 480px;
      min-width: 480px;
      max-width: calc(100vw - 500px);
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex-shrink: 0;
    }
    .canvas-column-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
    }
    .canvas-column-group legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    /* ===== ESTILOS DEL SPLITTER ===== */
    .splitter {
      width: 24px; /* Un poco m√°s ancho para emojis grandes */
      background: #fff;
      cursor: col-resize;
      display: flex !important;
      align-items: center;
      justify-content: center;
      position: relative;
      border-left: 1px solid #e9ecef;
      border-right: 1px solid #e9ecef;
      transition: all 0.2s ease;
      margin: 0;
      z-index: 10;
      flex-shrink: 0;
    }
    .splitter:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
    .splitter::before {
      content: "‚ÜîÔ∏è";
      font-size: 22px; /* Tama√±o aumentado */
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      /* filter: grayscale(0.6); Emoji m√°s suave en estado normal */
      transition: all 0.2s ease;
    }
    .splitter:hover::before {
      content: "üîõ";
      font-size: 24px; /* Un poco m√°s grande al hover */
      /* filter: grayscale(0.3); M√°s color */
    }
    .splitter.active {
      background: #e9ecef;
      border-color: #ced4da;
    }
    .splitter.active::before {
      content: "üîõ";
      font-size: 26px; /* A√∫n m√°s grande cuando est√° activo */
      /* filter: grayscale(0); Color completo */
      font-weight: 600;
    }
    /* Mejora para dispositivos con alta densidad de p√≠xeles */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .splitter::before {
          font-size: 20px;
      }
      .splitter:hover::before {
          font-size: 22px;
      }
      .splitter.active::before {
          font-size: 24px;
      }
    }

    /* Extender el √°rea clickeable SOLUCI√ìN CURSOR LEJANO*/
    .splitter:hover::after {
      left: -6px;
      right: -6px;
    }
    /* ===== ESTILOS RESPONSIVOS ===== */
    @media (max-width: 1600px) {
      #col-formularios {
        width: 420px;
        min-width: 420px;
      }
      
      #col-gemini {
        width: 420px;
        min-width: 420px;
      }
    }
    @media (max-width: 1400px) {
      #col-formularios {
        width: 380px;
        min-width: 380px;
      }
      
      #col-gemini {
        width: 380px;
        min-width: 380px;
      }
      
      #col-canvas {
        min-width: 350px;
      }
    }
    /* Textarea de Agentes fijo */
    #gemini-prompt {
      width: 100%;
      box-sizing: border-box;
      resize: none;       /* ‚ùå desactiva el redimensionamiento */
    }
    .btn-seccion {
      font-family: 'Mulish', sans-serif;
      font-size: 14px;
      font-weight: 500;
      background: none;
      border: none;
      text-align: left;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-seccion:hover {
      background: #f2f2f2;
      border-radius: 6px;
    }
    #col-gemini .agente-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    #col-gemini .agente-header {
      display: flex;
      justify-content: flex-start;
    }
    #col-gemini .agente-btn {
      font-family: 'Mulish', sans-serif;
      font-size: 14px;
      font-weight: 600;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      width: 138px; /* ancho fijo */
      text-align: center;
    }
    #col-gemini .agente-btn:hover {
      background: #f5f5f5;
    }
    #col-gemini .agente-output {
      min-height: 80px;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      white-space: pre-wrap;
    }
    /* ===== ESTILOS PARA BOTONES DE BORRADO ===== */
    #col-gemini .agente-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px; /* Espacio entre botones */
    }
    .btn-borrar {
      width: 30px;
      height: 30px;
      font-size: 16px;
      margin-left: 5px;
      padding: 0;
      border-radius: 6px;
      border: none; /* ‚ùå ELIMINADO: borde negro */
      background-color: transparent; /* ‚ùå ELIMINADO: fondo blanco */
      color: #dc3545;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-sizing: border-box;
      opacity: 0.6; /* Opacidad inicial siempre visible */
    }
    .btn-borrar:hover {
      background-color: transparent; /* ‚ùå ELIMINADO: fondo negro */
      /* color: white; */
      transform: scale(1.05);
      opacity: 1; /* Opacidad completa al hacer hover */
    }
    .btn-borrar:active {
      transform: scale(0.95);
    }
    /* ===== ESTILOS PARA BOT√ìN DE MEN√ö ===== */
    .btn-menu {
      position: fixed;
      top: 50px;
      right: 30px;
      width: 30px;
      height: 30px;
      font-size: 30px;
      padding: 0;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s ease;
      box-sizing: border-box;
      z-index: 1000;
      text-decoration: none; /* Elimina la l√≠nea inferior del enlace */
    }
    .btn-menu:hover {
      color: white;
      transform: scale(1.05);
    }
    .btn-menu:active {
      transform: scale(0.95);
    }
    /*STYLES PARA MODALES */
    /* Modal para elegir logo - NUEVOS ESTILOS */
    #modalLogos {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); /* necesario para el marco del modal */
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    /* Modal para elegir √≠cono - NUEVOS ESTILOS */
    #modalIconos {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); /* necesario para el marco del modal */
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    /* Contenido del modal */
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 80%;
      overflow: auto;
    }
    /* Contenedor de im√°genes */
    #galeriaLogos, #galeriaIconos {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    /* Im√°genes dentro de los modales */
    #galeriaLogos img, #galeriaIconos img {
      background: rgba(0, 0, 0, 0.4); /* Fondo gris m√°s oscuro (1 (Transparente) <-> 0 (sin opacidad) 0*/
      object-fit: contain; /* Mantiene proporciones sin distorsi√≥n */
      width: auto;
      height: auto;
      max-width: 80px;
      max-height: 80px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Bot√≥n de cerrar */
    .modal-close {
      font-family: 'Mulish', sans-serif;
      margin-top: 10px;
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal-close:hover {
      background: #5a6268;
    }
  </style>
  <script type="module" src="./js/auth.js"></script>
</head>
  
<body style="display:none">
  <a href="/TRKKN_CO/menu.html" class="btn-menu" title="Ir al men√∫ principal">üîô</a>
  <h1><img src="logo_omniadsai_tigo.png" alt="Cargando Logo Tigo OmniAdsAI TRKKN..." style= "width: 500px; margin-left: 20px" /></h1>

  <div id="main-container">

    <!-- Columna izquierda: Formularios -->
    <div id="col-formularios">
      <form id="formulario"></form>
    </div>

    <!-- Columna central: Canvas -->
    <div id="col-canvas">
      <fieldset class="canvas-column-group">
        <legend>üé® Tama√±os / Plantillas</legend>
        <div class="canvas-wrapper" id="canvasContainer"></div>
      </fieldset>
    </div>

    <!-- Splitter entre columna central y Gemini -->
    <div class="splitter" id="canvas-gemini-splitter"></div>

    <!-- Columna derecha: Gemini AI -->
    <div id="col-gemini"> 
      <fieldset class="canvas-column-group">
        <legend>
          <img src="./logo_geminianimado.webp" alt="logo_gemini" style="height: 30px; vertical-align: middle; margin-right: 4px;">
          Gemini (Topic Mine) 
        </legend>
    
        <!-- ‚úçÔ∏è Copies -->
        <section class="agente-section">
          <div class="agente-header">
            <button id="btn-copies" type="button" class="agente-btn">‚úçÔ∏è Copies</button>
            <button id="btn-clear-copies" class="btn-borrar" data-target="copies" title="Borrar contenido">üóëÔ∏è</button>
          </div>
          <div id="agente-output-copies" class="agente-output"></div>
        </section>
    
        <!-- üîé Insights -->
        <section class="agente-section">
          <div class="agente-header">
            <button id="btn-insights" type="button" class="agente-btn">üîé Insights</button>
            <button id="btn-clear-insights" class="btn-borrar" data-target="insights" title="Borrar contenido">üóëÔ∏è</button>
          </div>
          <div id="agente-output-insights" class="agente-output"></div>
        </section>
    
        <!-- ü•ä Competencia -->
        <section class="agente-section">
          <div class="agente-header">
            <button id="btn-competencia" type="button" class="agente-btn">ü•ä Competencia</button>
            <button id="btn-clear-competencia" class="btn-borrar" data-target="competencia" title="Borrar contenido">üóëÔ∏è</button>
          </div>
          <div id="agente-output-competencia" class="agente-output"></div>
        </section>
    
        <!-- üìà Tendencias -->
        <section class="agente-section">
          <div class="agente-header">
            <button id="btn-tendencias" type="button" class="agente-btn">üìà Tendencias</button>
            <button id="btn-clear-tendencias" class="btn-borrar" data-target="tendencias" title="Borrar contenido">üóëÔ∏è</button>
          </div>
          <div id="agente-output-tendencias" class="agente-output"></div>
        </section>
      </fieldset>
    </div>
  </div>

  <script type="module">
    import { cargarJerarquia } from "./js/infoProduct.js";
    import { cargarAudienciaFactores } from "./js/audienciaFactores.js";
    import { borradoPorTeclado } from "./js/controlesCanvas.js";
    import { cargarTamanosYCanvas } from "./js/canvasLoader.js";
    import { inicializarSplitter } from "./js/splitter.js";
    import "./js/geminiAgentes.js";
    
    document.addEventListener("DOMContentLoaded", async () => {
      await cargarJerarquia(); // carga productos en select
      // cargar audiencias y factores vac√≠os inicialmente (pasamos string vac√≠o)
      await cargarAudienciaFactores("");
      await borradoPorTeclado();
      // await cargarTamanosYCanvas(); NO LLAMAR cargarTamanosYCanvas() al cargar la p√°gina (antes s√≠ la llamabas al cargar audiencias).

      // Inicializar el splitter despu√©s de que todo est√© cargado
      inicializarSplitter();
      
      // Al cambiar el producto en el dropdown recarga audiencias y factores
      const productoSelect = document.getElementById("producto");
      productoSelect.addEventListener("change", async () => {
        await cargarAudienciaFactores(productoSelect.value);
        await cargarTamanosYCanvas();
      });
    });
  </script>
  
  <script type="module">
    import { mostrarGaleriaLogos, mostrarGaleriaIconos, agregarTexto, limpiarCanvas, crearControlesTexto } from "../../Anunciante/Tigo/js/controlesCanvas.js";
  
    document.addEventListener("DOMContentLoaded", () => {
      const intervalo = setInterval(() => {
        if (window.canvasRefs) {
          clearInterval(intervalo);
  
          for (const [id, ref] of Object.entries(window.canvasRefs)) {
            const controls = document.createElement("div");
            controls.style.display = "flex";
            controls.style.gap = "10px";
            controls.style.marginTop = "10px";
            controls.style.marginBottom = "20px";
  
            const btnLogo = document.createElement("button");
            btnLogo.textContent = "¬ÆÔ∏è";
            btnLogo.title = "A√±adir logo";
            btnLogo.onclick = () => {
              mostrarGaleriaLogos(ref.canvas);
            };
  
            const btnIcono = document.createElement("button");
            btnIcono.textContent = "‚ÑπÔ∏è";
            btnIcono.title = "A√±adir √≠cono";
            btnIcono.onclick = () => {
              mostrarGaleriaIconos(ref.canvas);
            };
  
            const btnTexto = document.createElement("button");
            btnTexto.textContent = "‚úèÔ∏è";
            btnTexto.title = "A√±adir texto";
            btnTexto.onclick = () => {
              agregarTexto(ref.canvas);
            };
  
            const btnLimpiar = document.createElement("button");
            btnLimpiar.textContent = "üîÑ";
            btnLimpiar.title = "Limpiar canvas";
            btnLimpiar.onclick = () => {
              limpiarCanvas(ref.canvas);
            };
  
            controls.appendChild(btnLogo);
            controls.appendChild(btnIcono);
            controls.appendChild(btnTexto);
            controls.appendChild(btnLimpiar);

            const [fontSelector, colorPicker, shadowToggle, shadowColorPicker, shadowOpacitySlider] = crearControlesTexto(ref);
            controls.appendChild(fontSelector);
            controls.appendChild(colorPicker);
            controls.appendChild(shadowToggle);
            controls.appendChild(shadowColorPicker);
            controls.appendChild(shadowOpacitySlider);

            // Crear contenedor de miniaturas (galer√≠a)
            const galeria = document.createElement("div");
            galeria.className = "galeria-thumbs";
            galeria.id = `galeria_${id}`;
            ref.galeriaId = galeria.id; // Guarda el ID por si lo necesitas luego
  
            ref.canvas.wrapperEl.parentElement.appendChild(controls);
            // Insertar la galer√≠a en el DOM
            ref.canvas.wrapperEl.parentElement.appendChild(galeria);
          }
        }
      }, 200);
    });
  </script>

  <!-- Modal para elegir logo - QUITAR ESTILOS EN L√çNEA -->
  <div id="modalLogos">
    <div class="modal-content">
      <h3>Selecciona un logo</h3>
      <div id="galeriaLogos"></div>
      <button class="modal-close" onclick="document.getElementById('modalLogos').style.display='none'">Cerrar</button>
    </div>
  </div>

  <!-- Modal para elegir √≠cono - QUITAR ESTILOS EN L√çNEA -->
  <div id="modalIconos">
    <div class="modal-content">
      <h3>Selecciona un √≠cono</h3>
      <div id="galeriaIconos"></div>
      <button class="modal-close" onclick="document.getElementById('modalIconos').style.display='none'">Cerrar</button>
    </div>
  </div>

  <script type="module">
    import { generarCreatividadesConFondos } from "../../Anunciante/Tigo/js/controlesCanvas.js";
  
    function obtenerValoresSeleccionados(name) {
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
    }
    
    function obtenerFactorYOpciones() {
      const factores = {};
      const inputs = document.querySelectorAll('fieldset.form-group input[type="checkbox"]');
      inputs.forEach(input => {
        const nombre = input.name;
        if (!factores[nombre]) factores[nombre] = [];
        if (input.checked) factores[nombre].push(input.value);
      });
      return factores;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const btnGenerar = document.createElement("button");
      btnGenerar.textContent = "üöÄ Generar creatividades";
      btnGenerar.style.maxWidth = "250px";
      btnGenerar.style.overflow = "hidden";
      btnGenerar.style.textOverflow = "ellipsis";
      btnGenerar.style.marginTop = "16px";
      btnGenerar.style.padding = "12px 10px";
      btnGenerar.style.fontSize = "18px";
      btnGenerar.style.fontWeight = "bold";
      btnGenerar.style.borderRadius = "8px";
      btnGenerar.style.backgroundColor = "#4CAF50";
      btnGenerar.style.color = "#fff";
      btnGenerar.style.border = "none";
      btnGenerar.style.cursor = "pointer";
    
      document.getElementById("formulario").insertAdjacentElement("afterend", btnGenerar);

      btnGenerar.onclick = () => {
        const galeriaGlobal = document.getElementById("galeriaResultados");
        if (!galeriaGlobal) return;
        galeriaGlobal.innerHTML = "";
      
        const audiencias = obtenerValoresSeleccionados("audiencia");
        const factores = obtenerFactorYOpciones();
        const productoSelect = document.getElementById("producto");
        const nombreProducto = productoSelect?.value || "producto";
        const canvasRefs = window.canvasRefs || {};
      
        // construir combinaciones (audiencia x factor x opcion x tama√±o)
        const combos = [];
        audiencias.forEach(audId => {
          for (const factorId in factores) {
            if (factorId.toLowerCase() === "audiencia" || factorId.toLowerCase() === "tamanos") continue; // Ignorar factor "tamanos"
            factores[factorId].forEach(opcionId => {
              for (const tama√±oId in canvasRefs) {
                const ref = canvasRefs[tama√±oId];
                if (!ref.activo) continue;
                combos.push({ ref, audId, factorId, opcionId, tama√±oId });
              }
            });
          }
        });

        if (combos.length === 0) {
          alert("‚ö†Ô∏è No hay creatividades para generar (revisa tus selecciones).");
          return;
        }
      
        // contador por combinaci√≥n (no por imagen) ‚Äî esperamos a que cada combinaci√≥n marque done = true
        let pendientes = combos.length;
        const rutasFaltantes = new Set();
        let generadas = 0;
      
        combos.forEach(c => {
          generarCreatividadesConFondos(
            c.ref.canvas,
            c.audId,
            c.factorId,
            c.opcionId,
            c.tama√±oId,
            nombreProducto,
            (dataURL, nombreCreatividad, fondoNoEncontrado, rutasProbadas, done) => {
              // rutas sin fondos (fondos.json no existe)
              if (fondoNoEncontrado) {
                (rutasProbadas || []).forEach(r => rutasFaltantes.add(r));
              }
      
              // recibimos una creatividad lista ‚Üí mostrarla y contarla
              if (dataURL) {
                generadas++;
                const wrapper = document.createElement("div");
                wrapper.className = "thumb-wrapper";
      
                const img = document.createElement("img");
                img.src = dataURL;
                img.className = "thumbnail-preview";
                img.title = nombreCreatividad;
                img.onclick = () => window.open(dataURL, "_blank");
      
                const title = document.createElement("div");
                title.className = "thumb-title";
                title.textContent = nombreCreatividad;
      
                const download = document.createElement("a");
                download.href = dataURL;
                download.download = nombreCreatividad;
                download.className = "download-link";
                download.textContent = "Descargar";
      
                wrapper.appendChild(img);
                wrapper.appendChild(title);
                wrapper.appendChild(download);
                galeriaGlobal.appendChild(wrapper);
              }
      
              // cuando la combinaci√≥n indique done=true, restamos pendientes
              if (done) {
                pendientes--;
                if (pendientes === 0) {
                  // Esperar a que el DOM termine de insertar y renderizar la √∫ltima creatividad
                  requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                      let mensaje = `üéâ ${generadas} creatividades generadas correctamente.`;
                      if (rutasFaltantes.size > 0) {
                        mensaje += `\n‚ö†Ô∏è ${rutasFaltantes.size} rutas que no cuentan con fondos.`;
                        mensaje += `\n\nüìÇ Rutas faltantes:\n- ${Array.from(rutasFaltantes).join("\n- ")}`;
                      }
                      alert(mensaje);
                    });
                  });
                }
              }
            }
          );
        });
      };  // üëà cierre de la funci√≥n onclick 
    });  // üëà cierre del DOMContentLoaded
  </script> <!-- üëà cierre del bloque script -->

  <h3>üéûÔ∏è Creatividades generadas ‚ö°</h3>
  <section id="resultados">
    <div id="galeriaResultados"></div>
  </section>

  <script src="./js/indicadoresEconomicos.js"></script>
  </body>
</html>
